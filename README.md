# ğŸš€ react-fastapi-prototype

## ğŸ§­ æ¦‚è¦

**react-fastapi-prototype** ã¯ã€
**ã€Œé–‹ç™ºåˆæœŸã«å³ã‚¢ãƒ—ãƒªã‚’ç«‹ã¡ä¸Šã’ã€ãƒ­ã‚¸ãƒƒã‚¯ã«é›†ä¸­ã™ã‚‹ãŸã‚ã®æœ€å°æ§‹æˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€** ã§ã™ã€‚

React (Vite) + FastAPI + MySQL ã‚’ **Docker Compose** ã§çµ±åˆã—ã€
Caddy ã«ã‚ˆã‚‹ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã§ **å˜ä¸€ãƒãƒ¼ãƒˆé‹ç”¨** ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

---

## ğŸ’¡ ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ€æƒ³

### âœ… ãƒã‚¤ãƒ³ãƒˆ

* **æœ€çŸ­ã§å‹•ã**ï¼š`docker compose up --profile dev` ã§ã™ãç«‹ã¡ä¸ŠãŒã‚‹
* **å˜ä¸€ãƒãƒ¼ãƒˆæ§‹æˆ**ï¼šCaddy ãŒ `/api` ã‚’ FastAPI ã«ã€ãã‚Œä»¥å¤–ã‚’ React ã«æŒ¯ã‚Šåˆ†ã‘
* **é–‹ç™º/æœ¬ç•ªã‚’ profile ã§åˆ‡ã‚Šåˆ†ã‘**

  * `dev`ï¼šVite ã® HMRï¼ˆ5173ï¼‰ã‚’ä½¿ã„ãªãŒã‚‰å³æ™‚é–‹ç™º
  * `prod`ï¼šHTTPS + ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ + é™çš„é…ä¿¡ï¼ˆãƒ“ãƒ«ãƒ‰æ¸ˆã¿ï¼‰
* **HTTPS/ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾å¿œã‚’æœ€é€Ÿã§å°å…¥**ï¼šLet's Encrypt ã«ã‚ˆã‚‹è‡ªå‹•è¨¼æ˜æ›¸ç™ºè¡Œ
* **VS Code ã§ã™ãç·¨é›†å¯èƒ½**ï¼šãƒ›ã‚¹ãƒˆã® `node_modules` ã‚’åˆ©ç”¨ã—å‹è£œå®ŒOK
* **Todo ã‚¢ãƒ—ãƒªä»˜ã**ï¼šèµ·å‹•ç›´å¾Œã«å‹•ä½œç¢ºèªå¯èƒ½

### ğŸš« ã‚ãˆã¦ã—ã¦ã„ãªã„ã“ã¨

* ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆAlembic ç­‰ï¼‰æœªæ­è¼‰
* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼‰æœªå®Ÿè£…
* é•·æœŸé‹ç”¨ã‚’æƒ³å®šã—ãŸ CI/CD æ§‹æˆã‚„ç’°å¢ƒåˆ†é›¢ã¯æœ€å°é™

> **ç›®çš„ã¯ã€Œæœ€åˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãå§‹ã‚ã‚‹ã¾ã§ã®éšœå£ã‚’æ¥µé™ã¾ã§æ¸›ã‚‰ã™ã“ã¨ã€ã€‚**
>
> ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ®µéšã§ã¯ã€Œå‹•ãã“ã¨ã€ã‚’æœ€å„ªå…ˆã€‚
> é•·æœŸé–‹ç™ºã‚„æœ¬ç•ªé‹ç”¨ã§ã¯ã€ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’åŸºç›¤ã«è‡ªç”±ã«æ‹¡å¼µã—ã¦ãã ã•ã„ã€‚

---

## âš™ï¸ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é‹ç”¨

| profile  | ç”¨é€”        | ç‰¹å¾´                             | å…¬é–‹ãƒãƒ¼ãƒˆ               |
| -------- | --------- | ------------------------------ | ------------------- |
| **dev**  | é–‹ç™ºãƒ»HMRã‚ã‚Š  | Vite dev server (5173) ã‚’ãã®ã¾ã¾åˆ©ç”¨ | 5173 |
| **prod** | æœ¬ç•ªãƒ»ã‚µãƒ¼ãƒ“ã‚¹å…¬é–‹ | HTTPS + ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ + é™çš„é…ä¿¡          | 80 / 443            |

---

## ğŸ§© é–‹ç™ºï¼ˆprofile=devï¼‰

é–‹ç™ºæ™‚ã¯ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆHMRï¼‰ã‚’æœ‰åŠ¹ã«ã—ã€
**Caddy ãŒ `/api` ã‚’ FastAPI ã«ã€ãã‚Œä»¥å¤–ã‚’ Vite ã«è»¢é€**ã—ã¾ã™ã€‚

### èµ·å‹•æ‰‹é †

```bash
docker compose --profile dev up
```

### ã‚¢ã‚¯ã‚»ã‚¹

* React (Vite)ï¼š [http://localhost:5173](http://localhost:5173)
* FastAPIï¼š Caddy çµŒç”±ã§ `/api` ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹

> EC2 ä¸Šã§å…¬é–‹ã™ã‚‹å ´åˆã‚‚ã€**5173 ãƒãƒ¼ãƒˆã‚’é–‹æ”¾**ã—ã¦ãã ã•ã„ã€‚
> HTTPS ã¯ä¸è¦ã§ã€HMR ã‚’ãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚

---

## ğŸŒ æœ¬ç•ªï¼ˆprofile=prodï¼‰

æœ¬ç•ªã§ã¯ã€Vite ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦é™çš„é…ä¿¡ã—ã¾ã™ã€‚
Caddy ãŒ **Let's Encrypt ã§è‡ªå‹•çš„ã«è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã€HTTPS/ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã§é…ä¿¡**ã—ã¾ã™ã€‚

### .env ã®è¨­å®š(ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨Let's Encrypt é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã¯æœ¬ç•ªã®ã¿å‚ç…§)

```bash
# ---- MySQLï¼ˆå…±é€šï¼‰ ----
DB_HOST=db
DB_USER=app
DB_PASSWORD=app_pw
DB_ROOT_PASSWORD=password
DB_NAME=appdb

# ---- æœ¬ç•ªã®ã¿ä½¿ç”¨ ----
SITE_DOMAIN=example.com           # ã¾ãŸã¯ 13.112.109.54.nip.io
ACME_EMAIL=admin@example.com      # Let's Encrypt é€šçŸ¥ç”¨
```

### èµ·å‹•ã‚³ãƒãƒ³ãƒ‰

```bash
docker compose --profile prod up
```

### ã‚¢ã‚¯ã‚»ã‚¹

* HTTPSï¼š `https://<SITE_DOMAIN>`
* è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼š `http://<SITE_DOMAIN>` â†’ `https://<SITE_DOMAIN>`

---

## âš™ï¸ æ§‹æˆæ¦‚è¦

```
â”œâ”€â”€ Caddyfile                 # dev ç”¨
â”œâ”€â”€ Caddyfile.prod            # prod ç”¨ï¼ˆHTTPSå¯¾å¿œï¼‰
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env.example
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/main.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â””â”€â”€ package.json
â””â”€â”€ db/
    â””â”€â”€ init/001_schema.sql
```

---

## ğŸ” ãƒãƒ¼ãƒˆæ§‹æˆã¨ãƒ—ãƒ­ã‚­ã‚·æŒ™å‹•

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ                | ãƒãƒ¼ãƒˆ    | ç”¨é€”                  |
| ---------------------- | ------ | ------------------- |
| **frontend (Vite)**    | 5173   | é–‹ç™ºæ™‚ã®ã¿ HMR ç”¨         |
| **backend (FastAPI)**  | 8000   | API ã‚µãƒ¼ãƒ             |
| **db (MySQL)**         | 3306   | DB                  |
| **proxy-dev (Caddy)**  | 5173   | é–‹ç™ºæ™‚ï¼šå˜ä¸€ãƒãƒ¼ãƒˆã«è¦‹ã›ã‚‹ãƒªãƒãƒ—ãƒ­   |
| **proxy-prod (Caddy)** | 80/443 | æœ¬ç•ªï¼šHTTPS + ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³é…ä¿¡ |

---

## ğŸ§© ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«

### é–‹ç™ºç”¨ Caddyfile

```caddy
:5173 {
  handle /api* {
    reverse_proxy backend:8000
  }
  handle {
    reverse_proxy frontend:5173
  }
}
```

### æœ¬ç•ªç”¨ Caddyfile.prod

```caddy
{
  email {$ACME_EMAIL}
  acme_ca https://acme-v02.api.letsencrypt.org/directory
}

http://{$SITE_DOMAIN} {
  redir https://{$SITE_DOMAIN}{uri}
}

https://{$SITE_DOMAIN} {
  @api path /api/*
  handle @api {
    reverse_proxy backend:8000
  }
  handle {
    root * /srv
    try_files {path} /index.html
    file_server
  }

  encode zstd gzip
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "strict-origin-when-cross-origin"
  }
}
```

---

## ğŸ§­ ä½¿ã„åˆ†ã‘ã®ã¾ã¨ã‚

| ç’°å¢ƒ     | ã‚³ãƒãƒ³ãƒ‰                               | ãƒãƒ¼ãƒˆ    | HTTPS | å‚™è€ƒ                     |
| ------ | ---------------------------------- | ------ | ----- | ---------------------- |
| **é–‹ç™º** | `docker compose --profile dev up`  | 5173   | Ã—     | HMR æœ‰åŠ¹ã€‚EC2 ã§ã‚‚ 5173 ã‚’é–‹æ”¾ |
| **æœ¬ç•ª** | `docker compose --profile prod up` | 80/443 | â—‹     | HTTPS + ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³é…ä¿¡       |

---

## ğŸ”— React ã‹ã‚‰ã® API ã‚¢ã‚¯ã‚»ã‚¹

```ts
// ç¾åœ¨ã®ã‚ªãƒªã‚¸ãƒ³ã‚’ãã®ã¾ã¾åˆ©ç”¨
const API_BASE = `${window.location.origin}/api`
```

ã“ã‚Œã«ã‚ˆã‚Šã€
**é–‹ç™ºï¼æœ¬ç•ªã§ç’°å¢ƒå¤‰æ•°ã®åˆ‡ã‚Šæ›¿ãˆä¸è¦**ã§ API é€šä¿¡ãŒè¡Œãˆã¾ã™ã€‚

---

## ğŸ§‘â€ğŸ’» ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå‘ã„ã¦ã„ã‚‹äºº

* å€‹äººãƒ»å°è¦æ¨¡ã§ PoCï¼è©¦ä½œã‚’å³å½¢ã«ã—ãŸã„
* HTTPSï¼ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ—©æœŸã«çµ„ã¿è¾¼ã¿ãŸã„
* ãƒãƒ¼ãƒ ã«é…å¸ƒã™ã‚‹å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ã‚’æ•´å‚™ã—ãŸã„
* é–‹ç™ºãƒ»æœ¬ç•ªã‚’ profile ä¸€ã¤ã§æ˜ç¤ºçš„ã«åˆ‡ã‚Šæ›¿ãˆãŸã„

---

## ğŸª¶ License

MIT License
